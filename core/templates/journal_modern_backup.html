{% extends "base_modern.html" %}

{% block title %}Trading Journal - BFI Signals{% endblock %}

{% block page_title %}Trading Journal{% endblock %}

{% block extra_js %}
<!-- Trading Journal Modal JavaScript -->
<script src="{{ url_for('static', filename='js/trading-journal-modal.js') }}"></script>
{% endblock %}

{% block extra_css %}
<!-- Trading Journal Modal CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/trading-journal-modal.css') }}">
<style>
    /* Trading Journal Specific Styles */
    .journal-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .journal-header {
        text-align: center;
        margin-bottom: 40px;
        padding: 40px 20px;
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--golden-accent);
        border-radius: var(--border-radius-lg);
        position: relative;
        overflow: hidden;
    }

    .journal-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--golden-primary), var(--golden-bright));
    }

    .journal-header h1 {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
    }

    .journal-header p {
        font-size: 16px;
        color: var(--text-secondary);
        margin: 0;
        font-style: italic;
    }

    /* Journal Stats Row */
    .journal-stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .journal-stat-card {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--golden-accent);
        border-radius: var(--border-radius);
        padding: 24px;
        box-shadow: var(--box-shadow);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        text-align: center;
    }

    .journal-stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--golden-primary), var(--golden-bright));
    }

    .journal-stat-card:hover {
        border-color: var(--golden-secondary);
        transform: translateY(-2px);
        box-shadow: var(--golden-glow);
    }

    .journal-stat-card h3 {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
    }

    .big-number {
        display: block;
        font-size: 36px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
        font-variant-numeric: tabular-nums;
    }

    .big-number.success {
        color: var(--success-color);
    }

    .big-number.profit {
        color: var(--profit-color);
    }

    .big-number.warning {
        color: var(--warning-color);
    }

    .stat-subtitle {
        font-size: 12px;
        color: var(--text-muted);
        margin: 0;
    }

    /* Signals Table Container */
    .signals-table-container {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--golden-accent);
        border-radius: var(--border-radius-lg);
        overflow: hidden;
        box-shadow: var(--box-shadow);
        margin-bottom: 32px;
    }

    /* Table Header */
    .table-header {
        padding: 24px 32px;
        background: rgba(212, 175, 55, 0.05);
        border-bottom: 1px solid var(--golden-accent);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
    }

    .table-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .table-title h2 {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .table-title .icon {
        font-size: 24px;
    }

    .table-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .filter-btn,
    .export-btn {
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--golden-accent);
        border-radius: 6px;
        color: var(--text-primary);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .filter-btn:hover,
    .export-btn:hover {
        background: var(--golden-accent);
        border-color: var(--golden-secondary);
    }

    /* Enhanced Table */
    .journal-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .journal-table th {
        background: rgba(255, 255, 255, 0.02);
        padding: 16px 20px;
        text-align: left;
        font-weight: 600;
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--golden-accent);
        white-space: nowrap;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .journal-table td {
        padding: 16px 20px;
        color: var(--text-primary);
        font-weight: 500;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        font-variant-numeric: tabular-nums;
        vertical-align: middle;
    }

    .journal-table tbody tr {
        transition: all 0.2s ease;
    }

    .journal-table tbody tr:hover {
        background: rgba(212, 175, 55, 0.03);
    }

    /* Table Cell Styles */
    .symbol-cell {
        font-weight: 700;
        color: var(--golden-primary);
    }

    .signal-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-block;
    }

    .signal-badge.buy {
        background: rgba(0, 255, 136, 0.1);
        color: var(--success-color);
        border: 1px solid rgba(0, 255, 136, 0.2);
    }

    .signal-badge.sell {
        background: rgba(255, 71, 87, 0.1);
        color: var(--danger-color);
        border: 1px solid rgba(255, 71, 87, 0.2);
    }

    .outcome-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-block;
    }

    .outcome-badge.win {
        background: rgba(0, 255, 136, 0.1);
        color: var(--success-color);
        border: 1px solid rgba(0, 255, 136, 0.2);
    }

    .outcome-badge.loss {
        background: rgba(255, 71, 87, 0.1);
        color: var(--danger-color);
        border: 1px solid rgba(255, 71, 87, 0.2);
    }

    .outcome-badge.breakeven {
        background: rgba(255, 165, 2, 0.1);
        color: var(--warning-color);
        border: 1px solid rgba(255, 165, 2, 0.2);
    }

    .outcome-badge.pending {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-muted);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .risk-badge {
        padding: 3px 8px;
        border-radius: 8px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .risk-badge.low {
        background: rgba(0, 255, 136, 0.1);
        color: var(--success-color);
    }

    .risk-badge.medium {
        background: rgba(255, 165, 2, 0.1);
        color: var(--warning-color);
    }

    .risk-badge.high {
        background: rgba(255, 71, 87, 0.1);
        color: var(--danger-color);
    }

    .profit-cell {
        font-weight: 700;
    }

    .profit-cell.positive {
        color: var(--profit-color);
    }

    .profit-cell.negative {
        color: var(--danger-color);
    }

    .profit-cell.neutral {
        color: var(--text-muted);
    }

    .probability-cell {
        font-weight: 600;
        color: var(--golden-primary);
    }

    .timestamp-cell {
        font-size: 12px;
        color: var(--text-muted);
    }

    /* Action Buttons */
    .action-btn {
        padding: 4px 8px;
        background: transparent;
        border: 1px solid var(--golden-accent);
        border-radius: 4px;
        color: var(--text-secondary);
        font-size: 11px;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-right: 4px;
    }

    .action-btn:hover {
        background: var(--golden-accent);
        color: var(--text-primary);
    }

    .action-btn.primary {
        background: var(--golden-primary);
        color: var(--primary-bg);
        border-color: var(--golden-bright);
    }

    .action-btn.primary:hover {
        background: var(--golden-bright);
    }

    .action-btn.danger {
        background: rgba(255, 71, 87, 0.1);
        color: var(--danger-color);
        border-color: rgba(255, 71, 87, 0.2);
    }

    .action-btn.danger:hover {
        background: var(--danger-color);
        color: white;
    }

    /* Add Trade Button */
    .btn-add-trade {
        padding: 8px 16px;
        background: var(--golden-primary);
        border: 1px solid var(--golden-bright);
        border-radius: 6px;
        color: var(--primary-bg);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .btn-add-trade:hover {
        background: var(--golden-bright);
        transform: translateY(-1px);
        box-shadow: var(--golden-glow);
    }

    /* Chart cell styling */
    .chart-cell {
        text-align: center;
    }

    .quantity-cell {
        font-weight: 600;
        color: var(--text-primary);
        text-align: center;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: var(--text-muted);
    }

    .empty-state .icon {
        font-size: 64px;
        margin-bottom: 16px;
        display: block;
        opacity: 0.5;
    }

    .empty-state h3 {
        font-size: 20px;
        margin-bottom: 8px;
        color: var(--text-secondary);
    }

    .empty-state p {
        font-size: 14px;
        margin-bottom: 24px;
    }

    /* Pagination */
    .pagination-container {
        padding: 20px 32px;
        background: rgba(255, 255, 255, 0.01);
        border-top: 1px solid var(--golden-accent);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
    }

    .pagination-info {
        font-size: 13px;
        color: var(--text-muted);
    }

    .pagination-controls {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .pagination-btn {
        padding: 6px 12px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--golden-accent);
        border-radius: 6px;
        color: var(--text-secondary);
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
    }

    .pagination-btn:hover:not(.disabled) {
        background: var(--golden-accent);
        color: var(--text-primary);
    }

    .pagination-btn.active {
        background: var(--golden-primary);
        color: var(--primary-bg);
        border-color: var(--golden-bright);
    }

    .pagination-btn.disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    /* Filters Panel */
    .filters-panel {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--golden-accent);
        border-radius: var(--border-radius);
        padding: 20px;
        margin-bottom: 20px;
        display: none;
    }

    .filters-panel.active {
        display: block;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
    }

    .filter-group label {
        display: block;
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
    }

    .filter-input,
    .filter-select {
        width: 100%;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--golden-accent);
        border-radius: 6px;
        color: var(--text-primary);
        font-size: 13px;
    }

    .filter-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
    }

    /* Mobile-first Responsive Design */
    
    /* Touch-friendly buttons on mobile */
    @media (max-width: 768px) {
        .journal-stats-row {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .table-header {
            flex-direction: column;
            align-items: stretch;
            gap: 16px;
        }
        
        .table-actions {
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn-add-trade,
        .filter-btn,
        .export-btn {
            min-height: 44px; /* Touch-friendly size */
            padding: 12px 16px;
            font-size: 14px;
        }
        
        .journal-table {
            font-size: 12px;
        }
        
        .journal-table th,
        .journal-table td {
            padding: 8px 12px;
        }
        
        .action-btn {
            min-height: 36px;
            padding: 6px 10px;
            font-size: 10px;
        }
        
        .pagination-container {
            flex-direction: column;
            text-align: center;
        }
        
        /* Horizontal scroll for table on mobile */
        .signals-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .journal-table {
            min-width: 600px; /* Ensure table doesn't get too cramped */
        }
        
        /* Stack filter controls vertically on mobile */
        .filters-grid {
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        .filter-actions {
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-actions button {
            width: 100%;
        }
    }

    @media (max-width: 480px) {
        .journal-stats-row {
            grid-template-columns: 1fr;
        }
        
        .journal-header {
            padding: 20px 16px;
        }
        
        .journal-header h1 {
            font-size: 22px;
        }
        
        .big-number {
            font-size: 24px;
        }
        
        .table-header {
            padding: 16px;
        }
        
        .pagination-container {
            padding: 16px;
        }
        
        .journal-container {
            padding: 0 12px;
        }
        
        /* Simplify action buttons on very small screens */
        .action-btn {
            font-size: 9px;
            padding: 4px 6px;
        }
        
        /* Make modals full-screen on mobile */
        .modal-content {
            margin: 10px;
            max-height: calc(100vh - 20px);
        }
    }
    
    /* Dark mode enhancements */
    @media (prefers-color-scheme: dark) {
        :root {
            --primary-bg: #0a0a0a;
            --card-bg: rgba(15, 15, 15, 0.95);
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
        }
    }
    
    /* High contrast mode support */
    @media (prefers-contrast: high) {
        .journal-table th,
        .journal-table td {
            border: 2px solid var(--golden-accent);
        }
        
        .form-control,
        .form-select {
            border: 2px solid var(--golden-accent);
        }
        
        .btn-add-trade,
        .action-btn {
            border: 2px solid var(--golden-bright);
        }
    }
    
    /* Reduced motion for accessibility */
    @media (prefers-reduced-motion: reduce) {
        * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }
    
    /* Print styles */
    @media print {
        .journal-header,
        .table-header,
        .pagination-container,
        .filters-panel {
            display: none;
        }
        
        .journal-table {
            border-collapse: collapse;
            width: 100%;
        }
        
        .journal-table th,
        .journal-table td {
            border: 1px solid #000;
            padding: 8px;
            color: #000;
            background: #fff;
        }
        
        .action-btn {
            display: none;
        }
    }
    
    /* Focus styles for accessibility */
    .btn-add-trade:focus,
    .filter-btn:focus,
    .export-btn:focus,
    .action-btn:focus {
        outline: 2px solid var(--golden-bright);
        outline-offset: 2px;
    }
    
    /* Hover effects for non-touch devices */
    @media (hover: hover) {
        .journal-table tbody tr:hover {
            background: rgba(212, 175, 55, 0.05);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.1);
        }
        
        .journal-stat-card:hover {
            transform: translateY(-3px);
        }
    }
    
    /* Loading states */
    .loading {
        pointer-events: none;
        opacity: 0.6;
    }
    
    .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin: -10px 0 0 -10px;
        border: 2px solid transparent;
        border-top: 2px solid var(--golden-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    /* Notification enhancements */
    .toast {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(20px);
    }
    
    .toast.success {
        background: rgba(0, 255, 136, 0.1);
        border-color: var(--success-color);
    }
    
    .toast.error {
        background: rgba(255, 71, 87, 0.1);
        border-color: var(--danger-color);
    }
    
    .toast.warning {
        background: rgba(255, 165, 2, 0.1);
        border-color: var(--warning-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="journal-container">
    <div class="journal-header">
        <h1>📝 Manual Trading Journal</h1>
        <p>Track Your Personal Trading Performance</p>
        {% if error %}
        <div style="color: #ff6b6b; background: rgba(255,71,87,0.1); padding: 10px; border-radius: 5px; margin: 10px 0;">
            <strong>⚠️ Error:</strong> {{ error }}
        </div>
        {% endif %}
    </div>
    
    <!-- Journal Stats Row -->
    <div class="journal-stats-row">
        <div class="journal-stat-card">
            <h3>Total Trades</h3>
            <span class="big-number">{{ stats.total_trades if stats else 0 }}</span>
            <p class="stat-subtitle">Manual entries</p>
        </div>
        
        <div class="journal-stat-card">
            <h3>Win Rate</h3>
            <span class="big-number success">{{ "{:.1f}".format(stats.win_rate) if stats and stats.win_rate else 0 }}%</span>
            <p class="stat-subtitle">Success ratio</p>
        </div>
        
        <div class="journal-stat-card">
            <h3>Avg Trade</h3>
            <span class="big-number warning">${{ "{:.2f}".format(stats.avg_trade_pnl) if stats and stats.avg_trade_pnl else 0 }}</span>
            <p class="stat-subtitle">Per trade average</p>
        </div>
        
        <div class="journal-stat-card">
            <h3>Total P&L</h3>
            <span class="big-number profit">${{ "{:.2f}".format(stats.total_pnl) if stats and stats.total_pnl else 0 }}</span>
            <p class="stat-subtitle">Net profit/loss</p>
        </div>
    </div>
    
    <!-- Signals Table -->
    <div class="signals-table-container">
        <div class="table-header">
            <div class="table-title">
                <span class="icon">📊</span>
                <h2>Manual Trade History</h2>
            </div>
            <div class="table-actions">
                <button class="btn-add-trade" id="addTradeBtn" data-action="add-trade" onclick="openTradeModal()">
                    ➕ Add New Trade
                </button>
                <button class="filter-btn" id="filterBtn" data-action="toggle-filters" onclick="handleFilterClick()">
                    🔍 Filter
                </button>
                <button class="export-btn" id="exportBtn" data-action="export-trades" onclick="handleExportClick()">
                    📥 Export CSV
                </button>
            </div>
        </div>
        
        <!-- Filters Panel -->
        <div class="filters-panel" id="filtersPanel">
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Symbol</label>
                    <select class="filter-select" id="symbolFilter">
                        <option value="">All Symbols</option>
                        <option value="NASDAQ">NASDAQ</option>
                        <option value="DOW">DOW</option>
                        <option value="GOLD">GOLD</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Signal Type</label>
                    <select class="filter-select" id="typeFilter">
                        <option value="">All Types</option>
                        <option value="BUY">BUY</option>
                        <option value="SELL">SELL</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Outcome</label>
                    <select class="filter-select" id="outcomeFilter">
                        <option value="">All Outcomes</option>
                        <option value="WIN">Win</option>
                        <option value="LOSS">Loss</option>
                        <option value="BREAKEVEN">Breakeven</option>
                        <option value="PENDING">Pending</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Date From</label>
                    <input type="date" class="filter-input" id="dateFromFilter">
                </div>
            </div>
            <div class="filter-actions">
                <button class="action-btn" onclick="clearFilters()">Clear</button>
                <button class="action-btn primary" onclick="applyFilters()">Apply Filters</button>
            </div>
        </div>
        
        {% if entries %}
        <!-- Manual Trade History Table -->
        <div style="overflow-x: auto;">
            <table class="journal-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Type</th>
                        <th>Entry Price</th>
                        <th>Exit Price</th>
                        <th>Quantity</th>
                        <th>Outcome</th>
                        <th>P&L</th>
                        <th>Date</th>
                        <th>Chart</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tradesTableBody">
                    {% for entry in entries %}
                    <tr data-entry-id="{{ entry.id }}">
                        <td class="symbol-cell">{{ entry.symbol }}</td>
                        <td>
                            <span class="signal-badge {{ 'buy' if entry.trade_type in ['CALL', 'LONG'] else 'sell' }}">
                                {{ entry.trade_type }}
                            </span>
                        </td>
                        <td class="price-cell">${{ "{:,.2f}".format(entry.entry_price) }}</td>
                        <td class="price-cell">
                            {% if entry.exit_price %}
                                ${{ "{:,.2f}".format(entry.exit_price) }}
                            {% else %}
                                --
                            {% endif %}
                        </td>
                        <td class="quantity-cell">{{ entry.quantity }}</td>
                        <td>
                            {% if entry.outcome == 'WIN' %}
                                <span class="outcome-badge win">✅ WIN</span>
                            {% elif entry.outcome == 'LOSS' %}
                                <span class="outcome-badge loss">❌ LOSS</span>
                            {% elif entry.outcome == 'BREAKEVEN' %}
                                <span class="outcome-badge breakeven">⚖️ BREAK</span>
                            {% else %}
                                <span class="outcome-badge pending">⏳ PENDING</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.profit_loss is not none %}
                                {% if entry.profit_loss > 0 %}
                                    <span class="profit-cell positive">+${{ "{:.2f}".format(entry.profit_loss) }}</span>
                                {% elif entry.profit_loss < 0 %}
                                    <span class="profit-cell negative">${{ "{:.2f}".format(entry.profit_loss) }}</span>
                                {% else %}
                                    <span class="profit-cell neutral">$0.00</span>
                                {% endif %}
                            {% else %}
                                <span class="profit-cell neutral">--</span>
                            {% endif %}
                        </td>
                        <td class="timestamp-cell">
                            <small>{{ entry.trade_date }}</small>
                            {% if entry.entry_time %}
                                <br><small class="text-muted">{{ entry.entry_time }}</small>
                            {% endif %}
                        </td>
                        <td class="chart-cell">
                            {% if entry.chart_image_path %}
                                <button class="action-btn" onclick="viewChart('{{ entry.chart_image_path }}')">
                                    🖼️ View
                                </button>
                            {% else %}
                                <span class="text-muted">--</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="action-btn" onclick="viewTradeDetails({{ entry.id }})">
                                👁️ View
                            </button>
                            <button class="action-btn" onclick="editTrade({{ entry.id }})">
                                ✏️ Edit
                            </button>
                            <button class="action-btn danger" onclick="deleteTrade({{ entry.id }})">
                                🗑️ Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="pagination-container">
            <div class="pagination-info" id="paginationInfo">
                Showing {{ entries|length }} of {{ entries|length }} trades
            </div>
            <div class="pagination-controls" id="paginationControls">
                <a href="#" class="pagination-btn disabled" onclick="loadPage(1)">← Previous</a>
                <a href="#" class="pagination-btn active">1</a>
                <a href="#" class="pagination-btn" onclick="loadPage(2)">Next →</a>
            </div>
        </div>
        
        {% else %}
        <div class="empty-state">
            <span class="icon">📈</span>
            <h3>No Manual Trades Yet</h3>
            <p>Start by adding your first manual trade to build your trading journal.</p>
            <button class="btn btn-primary" id="addFirstTradeBtn" data-action="add-trade" onclick="openTradeModal()">
                ➕ Add First Trade
            </button>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// =======================================================
// IMMEDIATE GLOBAL FUNCTIONS - ABSOLUTE TOP PRIORITY
// =======================================================

// Test function to verify script loading
console.log('🚀 SCRIPT LOADING STARTED - Trading Journal');

// MAIN FUNCTION - DEFINED FIRST AND FOREMOST
function openTradeModal() {
    console.log('🚀 openTradeModal called - DIRECT FUNCTION');
    alert('Add Trade Modal - Function Working!');
    
    // Simple modal for now to test
    const modalExists = document.querySelector('.trade-modal');
    if (modalExists) {
        modalExists.remove();
    }
    
    const modal = document.createElement('div');
    modal.className = 'trade-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    `;
    
    modal.innerHTML = `
        <div style="
            background: #1a1a1a;
            border: 1px solid #d4af37;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            color: white;
        ">
            <h3 style="color: #d4af37; margin-bottom: 16px;">✅ Modal Working!</h3>
            <p>The openTradeModal function is working correctly.</p>
            <button onclick="document.querySelector('.trade-modal').remove()" style="
                padding: 12px 24px;
                background: #d4af37;
                border: none;
                border-radius: 6px;
                color: #1a1a1a;
                cursor: pointer;
                font-weight: bold;
                margin-top: 16px;
            ">Close</button>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Also assign to window for maximum compatibility
window.openTradeModal = openTradeModal;

console.log('✅ openTradeModal defined');
console.log('Function type:', typeof openTradeModal);
console.log('Window function type:', typeof window.openTradeModal);

// Immediate global handlers - must work right away
window.handleAddTradeClick = function() {
    console.log('🚀 handleAddTradeClick called - WINDOW GLOBAL');
    return openTradeModal();
};

window.handleFilterClick = function() {
    console.log('🚀 handleFilterClick called - WINDOW GLOBAL');
    alert('Filter button clicked! Function working.');
};

window.handleExportClick = function() {
    console.log('🚀 handleExportClick called - WINDOW GLOBAL');
    alert('Export button clicked! Function working.');
};

// Also create non-window versions for compatibility
function handleAddTradeClick() {
    return window.handleAddTradeClick();
}

function handleFilterClick() {
    return window.handleFilterClick();
}

function handleExportClick() {
    return window.handleExportClick();
}

console.log('✅ IMMEDIATE HANDLERS DEFINED');
console.log('handleAddTradeClick type:', typeof handleAddTradeClick);
console.log('window.handleAddTradeClick type:', typeof window.handleAddTradeClick);

// Debug function to check availability
window.debugFunctions = function() {
    console.log('=== FUNCTION AVAILABILITY DEBUG ===');
    console.log('openTradeModal available:', typeof window.openTradeModal);
    console.log('closeTradeModal available:', typeof window.closeTradeModal);
    console.log('editTrade available:', typeof window.editTrade);
    console.log('viewTradeDetails available:', typeof window.viewTradeDetails);
    console.log('deleteTrade available:', typeof window.deleteTrade);
    console.log('submitTradeForm available:', typeof window.submitTradeForm);
    console.log('====================================');
};

// Main modal function - MUST be global and immediate
window.openTradeModal = function() {
    console.log('🔧 openTradeModal called');
    console.log('🔧 Function type check:', typeof window.createTradeModal);
    
    try {
        if (typeof window.createTradeModal === 'function') {
            window.createTradeModal(false, null);
        } else {
            console.error('❌ createTradeModal function not available');
            alert('Modal functionality not ready. Please refresh the page.');
        }
    } catch (error) {
        console.error('❌ Error in openTradeModal:', error);
        alert('Error opening trade modal: ' + error.message);
    }
};

// Close trade modal function - GLOBAL
window.closeTradeModal = function() {
    console.log('🔧 closeTradeModal called');
    try {
        const modal = document.querySelector('.trade-modal');
        if (modal) {
            modal.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.remove();
                }
            }, 300);
        }
    } catch (error) {
        console.error('❌ Error in closeTradeModal:', error);
    }
};

// Edit trade function - GLOBAL  
window.editTrade = function(entryId) {
    console.log('🔧 editTrade called for ID:', entryId);
    
    if (!entryId) {
        console.error('❌ No entry ID provided to editTrade');
        alert('Invalid trade ID');
        return;
    }
    
    try {
        // Store edit ID for later use
        window.currentEditId = entryId;
        
        // Fetch trade data
        fetch(`/journal/api/entry/${entryId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.entry) {
                console.log('✅ Trade data loaded:', data.entry);
                if (typeof window.createTradeModal === 'function') {
                    window.createTradeModal(true, data.entry);
                } else {
                    alert('Modal functionality not ready. Please refresh the page.');
                }
            } else {
                console.error('❌ Error loading trade:', data.error);
                alert(`Error loading trade: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('❌ Network error:', error);
            alert('Error loading trade data. Please try again.');
        });
    } catch (error) {
        console.error('❌ Error in editTrade:', error);
        alert('Error editing trade: ' + error.message);
    }
};

// View trade details function - GLOBAL
window.viewTradeDetails = function(entryId) {
    console.log('🔧 viewTradeDetails called for ID:', entryId);
    
    if (!entryId) {
        console.error('❌ No entry ID provided to viewTradeDetails');
        alert('Invalid trade ID');
        return;
    }
    
    try {
        fetch(`/journal/api/entry/${entryId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.entry) {
                if (typeof window.showTradeDetailsModal === 'function') {
                    window.showTradeDetailsModal(data.entry);
                } else {
                    alert('Modal functionality not ready. Please refresh the page.');
                }
            } else {
                alert(`Error loading trade details: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('❌ Network error:', error);
            alert('Error loading trade details. Please try again.');
        });
    } catch (error) {
        console.error('❌ Error in viewTradeDetails:', error);
        alert('Error viewing trade details: ' + error.message);
    }
};

// Delete trade function - GLOBAL
window.deleteTrade = function(entryId) {
    console.log('🔧 deleteTrade called for ID:', entryId);
    
    if (!entryId) {
        console.error('❌ No entry ID provided to deleteTrade');
        alert('Invalid trade ID');
        return;
    }
    
    if (confirm('Are you sure you want to delete this trade? This action cannot be undone.')) {
        try {
            fetch(`/journal/api/entry/${entryId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Success: ${data.message}`);
                    window.location.reload();
                } else {
                    alert(`Error: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('❌ Network error:', error);
                alert('Error deleting trade. Please try again.');
            });
        } catch (error) {
            console.error('❌ Error in deleteTrade:', error);
            alert('Error deleting trade: ' + error.message);
        }
    }
};

// Submit trade form function - GLOBAL
window.submitTradeForm = function(isEdit = false) {
    console.log('🔧 submitTradeForm called, isEdit:', isEdit);
    
    try {
        const form = document.getElementById('tradeForm');
        if (!form) {
            console.error('❌ Trade form not found');
            alert('Form not found. Please try again.');
            return;
        }
        
        // Validate required fields
        const symbol = document.getElementById('tradeSymbol')?.value?.trim();
        const tradeType = document.getElementById('tradeType')?.value;
        const entryPrice = document.getElementById('entryPrice')?.value;
        const tradeDate = document.getElementById('tradeDate')?.value;
        
        if (!symbol || !tradeType || !entryPrice || !tradeDate) {
            alert('Please fill in all required fields: Symbol, Trade Type, Entry Price, and Trade Date');
            return;
        }
        
        // Collect form data
        const formData = new FormData();
        formData.append('symbol', symbol.toUpperCase());
        formData.append('trade_type', tradeType);
        formData.append('entry_price', entryPrice);
        formData.append('exit_price', document.getElementById('exitPrice')?.value || '');
        formData.append('quantity', document.getElementById('quantity')?.value || '1');
        formData.append('outcome', document.getElementById('outcome')?.value || 'PENDING');
        formData.append('profit_loss', document.getElementById('profitLoss')?.value || '0');
        formData.append('trade_date', tradeDate);
        formData.append('entry_time', document.getElementById('entryTime')?.value || '');
        formData.append('exit_time', document.getElementById('exitTime')?.value || '');
        formData.append('notes', document.getElementById('notes')?.value || '');
        
        // Add chart image if uploaded
        const chartImage = document.getElementById('chartImage')?.files[0];
        if (chartImage) {
            formData.append('chart_image', chartImage);
        }
        
        // Show loading state
        const submitButton = document.querySelector('.modal-footer button[onclick*="submitTradeForm"]');
        if (submitButton) {
            const originalText = submitButton.textContent;
            submitButton.textContent = isEdit ? 'Updating...' : 'Adding...';
            submitButton.disabled = true;
            
            // Submit to API
            const url = isEdit ? `/journal/api/entry/${window.currentEditId}` : '/journal/api/create';
            const method = isEdit ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('✅ Trade saved successfully:', data.message);
                    alert(`Success: ${data.message}`);
                    window.closeTradeModal();
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    console.error('❌ Error saving trade:', data.error);
                    alert(`Error: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('❌ Network error:', error);
                alert('Network error. Please try again.');
            })
            .finally(() => {
                // Restore button state
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            });
        }
    } catch (error) {
        console.error('❌ Error in submitTradeForm:', error);
        alert('Error submitting form: ' + error.message);
    }
};

// Utility functions - GLOBAL
window.toggleFilters = function() {
    console.log('🔧 toggleFilters called');
    const filtersPanel = document.getElementById('filtersPanel');
    if (filtersPanel) {
        filtersPanel.classList.toggle('active');
    } else {
        alert('Filters functionality coming soon!');
    }
};

window.exportTrades = function() {
    console.log('🔧 exportTrades called');
    alert('Export functionality coming soon!');
};

// Modal creation function - GLOBAL
window.createTradeModal = function(isEdit = false, tradeData = null) {
    console.log('🔧 Creating trade modal, isEdit:', isEdit, 'tradeData:', tradeData);
    
    // Remove any existing modal
    const existingModal = document.querySelector('.trade-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modalTitle = isEdit ? '✏️ Edit Trade' : '➕ Add New Trade';
    const submitText = isEdit ? 'Update Trade' : 'Add Trade';
    
    // Create modal overlay
    const modal = document.createElement('div');
    modal.className = 'trade-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
    `;
    
    // Create modal content
    modal.innerHTML = `
        <div class="modal-content" style="
            background: var(--primary-bg);
            border: 1px solid var(--golden-primary);
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease;
        ">
            <div class="modal-header" style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 24px;
                padding-bottom: 16px;
                border-bottom: 1px solid var(--golden-accent);
            ">
                <h3 style="
                    color: var(--golden-primary);
                    margin: 0;
                    font-size: 20px;
                    font-weight: 600;
                ">${modalTitle}</h3>
                <button onclick="closeTradeModal()" style="
                    background: none;
                    border: none;
                    color: var(--text-secondary);
                    font-size: 24px;
                    cursor: pointer;
                    padding: 0;
                    line-height: 1;
                " title="Close">&times;</button>
            </div>
            
            <form id="tradeForm" style="display: grid; gap: 20px;">
                <!-- Symbol and Type Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="
                            display: block;
                            color: var(--text-secondary);
                            font-size: 12px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-bottom: 6px;
                        ">Symbol *</label>
                        <input type="text" id="tradeSymbol" name="symbol" required
                            placeholder="e.g., AAPL, NASDAQ, GOLD"
                            style="
                                width: 100%;
                                padding: 12px;
                                background: rgba(255, 255, 255, 0.05);
                                border: 1px solid var(--golden-accent);
                                border-radius: 6px;
                                color: var(--text-primary);
                                font-size: 14px;
                                text-transform: uppercase;
                            ">
                    </div>
                    <div>
                        <label style="
                            display: block;
                            color: var(--text-secondary);
                            font-size: 12px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-bottom: 6px;
                        ">Trade Type *</label>
                        <select id="tradeType" name="trade_type" required style="
                            width: 100%;
                            padding: 12px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid var(--golden-accent);
                            border-radius: 6px;
                            color: var(--text-primary);
                            font-size: 14px;
                        ">
                            <option value="">Select Type</option>
                            <option value="CALL">CALL (Bullish)</option>
                            <option value="PUT">PUT (Bearish)</option>
                            <option value="LONG">LONG (Buy)</option>
                            <option value="SHORT">SHORT (Sell)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Pricing Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="
                            display: block;
                            color: var(--text-secondary);
                            font-size: 12px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-bottom: 6px;
                        ">Entry Price *</label>
                        <input type="number" id="entryPrice" name="entry_price" step="0.01" required
                            placeholder="0.00"
                            style="
                                width: 100%;
                                padding: 12px;
                                background: rgba(255, 255, 255, 0.05);
                                border: 1px solid var(--golden-accent);
                                border-radius: 6px;
                                color: var(--text-primary);
                                font-size: 14px;
                            ">
                    </div>
                    <div>
                        <label style="
                            display: block;
                            color: var(--text-secondary);
                            font-size: 12px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-bottom: 6px;
                        ">Exit Price</label>
                        <input type="number" id="exitPrice" name="exit_price" step="0.01"
                            placeholder="0.00"
                            style="
                                width: 100%;
                                padding: 12px;
                                background: rgba(255, 255, 255, 0.05);
                                border: 1px solid var(--golden-accent);
                                border-radius: 6px;
                                color: var(--text-primary);
                                font-size: 14px;
                            ">
                    </div>
                    <div>
                        <label style="
                            display: block;
                            color: var(--text-secondary);
                            font-size: 12px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-bottom: 6px;
                        ">Quantity</label>
                        <input type="number" id="quantity" name="quantity" min="1" value="1"
                            style="
                                width: 100%;
                                padding: 12px;
                                background: rgba(255, 255, 255, 0.05);
                                border: 1px solid var(--golden-accent);
                                border-radius: 6px;
                                color: var(--text-primary);
                                font-size: 14px;
                            ">
                    </div>
                </div>
                
                <!-- Outcome and P&L Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="
                            display: block;
                            color: var(--text-secondary);
                            font-size: 12px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-bottom: 6px;
                        ">Outcome</label>
                        <select id="outcome" name="outcome" style="
                            width: 100%;
                            padding: 12px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid var(--golden-accent);
                            border-radius: 6px;
                            color: var(--text-primary);
                            font-size: 14px;
                        ">
                            <option value="PENDING">⏳ Pending</option>
                            <option value="WIN">✅ Win</option>
                            <option value="LOSS">❌ Loss</option>
                            <option value="BREAKEVEN">➖ Breakeven</option>
                        </select>
                    </div>
                    <div>
                        <label style="
                            display: block;
                            color: var(--text-secondary);
                            font-size: 12px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-bottom: 6px;
                        ">Profit/Loss ($)</label>
                        <input type="number" id="profitLoss" name="profit_loss" step="0.01"
                            placeholder="0.00"
                            style="
                                width: 100%;
                                padding: 12px;
                                background: rgba(255, 255, 255, 0.05);
                                border: 1px solid var(--golden-accent);
                                border-radius: 6px;
                                color: var(--text-primary);
                                font-size: 14px;
                            ">
                    </div>
                </div>
                
                <!-- Date and Time Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="
                            display: block;
                            color: var(--text-secondary);
                            font-size: 12px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-bottom: 6px;
                        ">Trade Date *</label>
                        <input type="date" id="tradeDate" name="trade_date" required
                            style="
                                width: 100%;
                                padding: 12px;
                                background: rgba(255, 255, 255, 0.05);
                                border: 1px solid var(--golden-accent);
                                border-radius: 6px;
                                color: var(--text-primary);
                                font-size: 14px;
                            ">
                    </div>
                    <div>
                        <label style="
                            display: block;
                            color: var(--text-secondary);
                            font-size: 12px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-bottom: 6px;
                        ">Entry Time</label>
                        <input type="time" id="entryTime" name="entry_time"
                            style="
                                width: 100%;
                                padding: 12px;
                                background: rgba(255, 255, 255, 0.05);
                                border: 1px solid var(--golden-accent);
                                border-radius: 6px;
                                color: var(--text-primary);
                                font-size: 14px;
                            ">
                    </div>
                    <div>
                        <label style="
                            display: block;
                            color: var(--text-secondary);
                            font-size: 12px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-bottom: 6px;
                        ">Exit Time</label>
                        <input type="time" id="exitTime" name="exit_time"
                            style="
                                width: 100%;
                                padding: 12px;
                                background: rgba(255, 255, 255, 0.05);
                                border: 1px solid var(--golden-accent);
                                border-radius: 6px;
                                color: var(--text-primary);
                                font-size: 14px;
                            ">
                    </div>
                </div>
                
                <!-- Notes -->
                <div>
                    <label style="
                        display: block;
                        color: var(--text-secondary);
                        font-size: 12px;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        margin-bottom: 6px;
                    ">Notes</label>
                    <textarea id="notes" name="notes" rows="3"
                        placeholder="Trade setup, strategy, lessons learned..."
                        style="
                            width: 100%;
                            padding: 12px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid var(--golden-accent);
                            border-radius: 6px;
                            color: var(--text-primary);
                            font-size: 14px;
                            resize: vertical;
                            min-height: 80px;
                        "></textarea>
                </div>
                
                <!-- Chart Image Upload -->
                <div>
                    <label style="
                        display: block;
                        color: var(--text-secondary);
                        font-size: 12px;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        margin-bottom: 6px;
                    ">Chart Screenshot</label>
                    <input type="file" id="chartImage" name="chart_image" accept="image/*"
                        style="
                            width: 100%;
                            padding: 12px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid var(--golden-accent);
                            border-radius: 6px;
                            color: var(--text-primary);
                            font-size: 14px;
                        ">
                    <small style="
                        color: var(--text-muted);
                        font-size: 11px;
                        margin-top: 4px;
                        display: block;
                    ">Supported: PNG, JPG, GIF (max 10MB)</small>
                </div>
            </form>
            
            <div class="modal-footer" style="
                display: flex;
                justify-content: flex-end;
                gap: 12px;
                margin-top: 24px;
                padding-top: 16px;
                border-top: 1px solid var(--golden-accent);
            ">
                <button type="button" onclick="closeTradeModal()" style="
                    padding: 12px 24px;
                    background: transparent;
                    border: 1px solid var(--text-secondary);
                    border-radius: 6px;
                    color: var(--text-secondary);
                    font-size: 14px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                " onmouseover="this.style.background='rgba(255,255,255,0.1)'" 
                   onmouseout="this.style.background='transparent'">Cancel</button>
                <button type="button" onclick="submitTradeForm(${isEdit})" style="
                    padding: 12px 24px;
                    background: var(--golden-primary);
                    border: none;
                    border-radius: 6px;
                    color: var(--primary-bg);
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s ease;
                " onmouseover="this.style.background='#E6C068'" 
                   onmouseout="this.style.background='var(--golden-primary)'">${submitText}</button>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.appendChild(modal);
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('tradeDate').value = today;
    
    // Pre-fill data for edit mode
    if (isEdit && tradeData) {
        document.getElementById('tradeSymbol').value = tradeData.symbol || '';
        document.getElementById('tradeType').value = tradeData.trade_type || '';
        document.getElementById('entryPrice').value = tradeData.entry_price || '';
        document.getElementById('exitPrice').value = tradeData.exit_price || '';
        document.getElementById('quantity').value = tradeData.quantity || 1;
        document.getElementById('outcome').value = tradeData.outcome || 'PENDING';
        document.getElementById('profitLoss').value = tradeData.profit_loss || '';
        document.getElementById('tradeDate').value = tradeData.trade_date || today;
        document.getElementById('entryTime').value = tradeData.entry_time || '';
        document.getElementById('exitTime').value = tradeData.exit_time || '';
        document.getElementById('notes').value = tradeData.notes || '';
    }
    
    // Focus first input
    setTimeout(() => {
        document.getElementById('tradeSymbol').focus();
    }, 100);
    
    // Close modal on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeTradeModal();
        }
    });
    
    // Close modal on overlay click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeTradeModal();
        }
    });
    
    console.log('✅ Trade modal created and displayed');
}

// Close trade modal function
window.closeTradeModal = function() {
    console.log('🔧 Closing trade modal...');
    const modal = document.querySelector('.trade-modal');
    if (modal) {
        modal.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
};

// Submit trade form function
window.submitTradeForm = function(isEdit = false) {
    console.log('🔧 Submitting trade form, isEdit:', isEdit);
    
    const form = document.getElementById('tradeForm');
    if (!form) {
        console.error('❌ Trade form not found');
        return;
    }
    
    // Validate required fields
    const symbol = document.getElementById('tradeSymbol').value.trim();
    const tradeType = document.getElementById('tradeType').value;
    const entryPrice = document.getElementById('entryPrice').value;
    const tradeDate = document.getElementById('tradeDate').value;
    
    if (!symbol || !tradeType || !entryPrice || !tradeDate) {
        alert('Please fill in all required fields: Symbol, Trade Type, Entry Price, and Trade Date');
        return;
    }
    
    // Collect form data
    const formData = new FormData();
    formData.append('symbol', symbol.toUpperCase());
    formData.append('trade_type', tradeType);
    formData.append('entry_price', entryPrice);
    formData.append('exit_price', document.getElementById('exitPrice').value || '');
    formData.append('quantity', document.getElementById('quantity').value || '1');
    formData.append('outcome', document.getElementById('outcome').value || 'PENDING');
    formData.append('profit_loss', document.getElementById('profitLoss').value || '0');
    formData.append('trade_date', tradeDate);
    formData.append('entry_time', document.getElementById('entryTime').value || '');
    formData.append('exit_time', document.getElementById('exitTime').value || '');
    formData.append('notes', document.getElementById('notes').value || '');
    
    // Add chart image if uploaded
    const chartImage = document.getElementById('chartImage').files[0];
    if (chartImage) {
        formData.append('chart_image', chartImage);
    }
    
    // Show loading state
    const submitButton = event.target;
    const originalText = submitButton.textContent;
    submitButton.textContent = isEdit ? 'Updating...' : 'Adding...';
    submitButton.disabled = true;
    
    // Submit to API
    const url = isEdit ? `/journal/api/entry/${window.currentEditId}` : '/journal/api/create';
    const method = isEdit ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Trade saved successfully:', data.message);
            alert(`Success: ${data.message}`);
            closeTradeModal();
            // Reload page to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 500);
        } else {
            console.error('❌ Error saving trade:', data.error);
            alert(`Error: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('❌ Network error:', error);
        alert('Network error. Please try again.');
    })
    .finally(() => {
        // Restore button state
        submitButton.textContent = originalText;
        submitButton.disabled = false;
    });
};

// Edit trade function
window.editTrade = function(entryId) {
    console.log('🔧 Loading trade for editing, ID:', entryId);
    
    // Store edit ID for later use
    window.currentEditId = entryId;
    
    // Fetch trade data
    fetch(`/journal/api/entry/${entryId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success && data.entry) {
            console.log('✅ Trade data loaded:', data.entry);
            createTradeModal(true, data.entry);
        } else {
            console.error('❌ Error loading trade:', data.error);
            alert(`Error loading trade: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('❌ Network error:', error);
        alert('Error loading trade data. Please try again.');
    });
};

window.viewTradeDetails = function(entryId) {
    console.log('🔧 Viewing trade details for ID:', entryId);
    
    fetch(`/journal/api/entry/${entryId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success && data.entry) {
            showTradeDetailsModal(data.entry);
        } else {
            alert(`Error loading trade details: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('❌ Network error:', error);
        alert('Error loading trade details. Please try again.');
    });
};

window.deleteTrade = function(entryId) {
    if (confirm('Are you sure you want to delete this trade? This action cannot be undone.')) {
        console.log('🔧 Deleting trade ID:', entryId);
        
        fetch(`/journal/api/entry/${entryId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Success: ${data.message}`);
                // Reload page to show updated data
                window.location.reload();
            } else {
                alert(`Error: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('❌ Network error:', error);
            alert('Error deleting trade. Please try again.');
        });
    }
};

window.toggleFilters = function() {
    console.log('🔧 Toggling filters panel');
    const filtersPanel = document.getElementById('filtersPanel');
    if (filtersPanel) {
        filtersPanel.classList.toggle('active');
    } else {
        alert('Filters functionality coming soon!');
    }
};

window.exportTrades = function() {
    console.log('🔧 Exporting trades to CSV');
    alert('Export functionality coming soon!');
};

window.closeModal = function() {
    // Alias for closeTradeModal for backwards compatibility
    closeTradeModal();
};

window.showNotification = function(message, type = 'info') {
    console.log(`📢 ${type.toUpperCase()}: ${message}`);
    alert(message);
};

// Function to show trade details modal (read-only) - GLOBAL
window.showTradeDetailsModal = function(trade) {
    console.log('🔧 Showing trade details modal for:', trade);
    
    // Remove any existing modal
    const existingModal = document.querySelector('.trade-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Create modal overlay
    const modal = document.createElement('div');
    modal.className = 'trade-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
    `;
    
    // Format profit/loss color
    const pnl = parseFloat(trade.profit_loss || 0);
    const pnlColor = pnl > 0 ? '#00FF88' : pnl < 0 ? '#FF4757' : '#FFA502';
    const pnlText = pnl >= 0 ? `+$${pnl.toFixed(2)}` : `$${pnl.toFixed(2)}`;
    
    // Create modal content
    modal.innerHTML = `
        <div class="modal-content" style="
            background: var(--primary-bg);
            border: 1px solid var(--golden-primary);
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease;
        ">
            <div class="modal-header" style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 24px;
                padding-bottom: 16px;
                border-bottom: 1px solid var(--golden-accent);
            ">
                <h3 style="
                    color: var(--golden-primary);
                    margin: 0;
                    font-size: 20px;
                    font-weight: 600;
                ">👁️ Trade Details</h3>
                <button onclick="closeTradeModal()" style="
                    background: none;
                    border: none;
                    color: var(--text-secondary);
                    font-size: 24px;
                    cursor: pointer;
                    padding: 0;
                    line-height: 1;
                " title="Close">&times;</button>
            </div>
            
            <div style="display: grid; gap: 16px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Symbol</label>
                        <div style="color: var(--golden-primary); font-size: 18px; font-weight: 600;">${trade.symbol || 'N/A'}</div>
                    </div>
                    <div>
                        <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Type</label>
                        <div style="color: var(--text-primary); font-size: 16px;">${trade.trade_type || 'N/A'}</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Entry Price</label>
                        <div style="color: var(--text-primary); font-size: 16px;">$${parseFloat(trade.entry_price || 0).toFixed(2)}</div>
                    </div>
                    <div>
                        <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Exit Price</label>
                        <div style="color: var(--text-primary); font-size: 16px;">${trade.exit_price ? '$' + parseFloat(trade.exit_price).toFixed(2) : 'N/A'}</div>
                    </div>
                    <div>
                        <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Quantity</label>
                        <div style="color: var(--text-primary); font-size: 16px;">${trade.quantity || 1}</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Outcome</label>
                        <div style="color: var(--text-primary); font-size: 16px;">
                            ${trade.outcome === 'WIN' ? '✅ Win' : 
                              trade.outcome === 'LOSS' ? '❌ Loss' : 
                              trade.outcome === 'BREAKEVEN' ? '➖ Breakeven' : '⏳ Pending'}
                        </div>
                    </div>
                    <div>
                        <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Profit/Loss</label>
                        <div style="color: ${pnlColor}; font-size: 18px; font-weight: 600;">${pnlText}</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Date</label>
                        <div style="color: var(--text-primary); font-size: 16px;">${trade.trade_date || 'N/A'}</div>
                    </div>
                    <div>
                        <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Entry Time</label>
                        <div style="color: var(--text-primary); font-size: 16px;">${trade.entry_time || 'N/A'}</div>
                    </div>
                    <div>
                        <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Exit Time</label>
                        <div style="color: var(--text-primary); font-size: 16px;">${trade.exit_time || 'N/A'}</div>
                    </div>
                </div>
                
                ${trade.notes ? `
                <div>
                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Notes</label>
                    <div style="
                        color: var(--text-primary); 
                        font-size: 14px; 
                        background: rgba(255, 255, 255, 0.05);
                        padding: 12px;
                        border-radius: 6px;
                        margin-top: 6px;
                        border-left: 3px solid var(--golden-accent);
                    ">${trade.notes}</div>
                </div>
                ` : ''}
                
                ${trade.chart_image_path ? `
                <div>
                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase;">Chart</label>
                    <div style="margin-top: 6px;">
                        <img src="${trade.chart_image_path}" alt="Trade Chart" style="
                            max-width: 100%;
                            border-radius: 6px;
                            border: 1px solid var(--golden-accent);
                        ">
                    </div>
                </div>
                ` : ''}
            </div>
            
            <div class="modal-footer" style="
                display: flex;
                justify-content: flex-end;
                gap: 12px;
                margin-top: 24px;
                padding-top: 16px;
                border-top: 1px solid var(--golden-accent);
            ">
                <button type="button" onclick="closeTradeModal()" style="
                    padding: 12px 24px;
                    background: transparent;
                    border: 1px solid var(--text-secondary);
                    border-radius: 6px;
                    color: var(--text-secondary);
                    font-size: 14px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                " onmouseover="this.style.background='rgba(255,255,255,0.1)'" 
                   onmouseout="this.style.background='transparent'">Close</button>
                <button type="button" onclick="closeTradeModal(); editTrade(${trade.id});" style="
                    padding: 12px 24px;
                    background: var(--golden-primary);
                    border: none;
                    border-radius: 6px;
                    color: var(--primary-bg);
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s ease;
                " onmouseover="this.style.background='#E6C068'" 
                   onmouseout="this.style.background='var(--golden-primary)'">Edit Trade</button>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.appendChild(modal);
    
    // Close modal on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeTradeModal();
        }
    });
    
    // Close modal on overlay click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeTradeModal();
        }
    });
    
    console.log('✅ Trade details modal displayed');
}

// Simple test functions will be replaced with full implementations below

    // Trading Journal JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize journal functionality
        initializeJournal();
    });

    // Notification system already defined globally above

    function initializeJournal() {
        // Add hover effects to table rows
        document.querySelectorAll('.journal-table tbody tr').forEach(row => {
            row.addEventListener('mouseenter', function() {
                this.style.background = 'rgba(212, 175, 55, 0.05)';
            });
            
            row.addEventListener('mouseleave', function() {
                this.style.background = '';
            });
        });

        // Animate stat numbers on load
        animateStatNumbers();
        
        // Initialize enhanced features
        initializeSearch();
        initializeKeyboardShortcuts();
        
        // Add tooltip functionality
        initializeTooltips();
    }
    
    function initializeTooltips() {
        // Add tooltips to action buttons
        const tooltips = {
            'btn-add-trade': 'Add New Trade (Ctrl+N)',
            'filter-btn': 'Toggle Filters (Ctrl+F)', 
            'export-btn': 'Export visible trades to CSV'
        };
        
        Object.entries(tooltips).forEach(([className, text]) => {
            const elements = document.querySelectorAll(`.${className}`);
            elements.forEach(el => {
                el.title = text;
            });
        });
    }

    window.toggleFiltersImpl = function() {
        console.log('🔧 Toggle filters called');
        const filtersPanel = document.getElementById('filtersPanel');
        filtersPanel.classList.toggle('active');
    }

    window.clearFiltersImpl = function() {
        console.log('🔧 Clear filters called');
        document.querySelectorAll('.filter-select, .filter-input').forEach(input => {
            input.value = '';
        });
        window.applyFiltersImpl();
    }

    window.applyFiltersImpl = function() {
        console.log('🔧 Apply filters called');
        const symbolFilter = document.getElementById('symbolFilter').value;
        const typeFilter = document.getElementById('typeFilter').value;
        const outcomeFilter = document.getElementById('outcomeFilter').value;
        const dateFromFilter = document.getElementById('dateFromFilter').value;

        const rows = document.querySelectorAll('.journal-table tbody tr');
        let visibleCount = 0;

        rows.forEach(row => {
            const symbol = row.querySelector('.symbol-cell')?.textContent || '';
            const type = row.querySelector('.signal-badge')?.textContent.trim() || '';
            const outcome = row.querySelector('.outcome-badge')?.textContent.trim() || '';
            const dateCell = row.querySelector('.timestamp-cell small')?.textContent || '';
            
            let show = true;

            // Symbol filter
            if (symbolFilter && !symbol.toUpperCase().includes(symbolFilter.toUpperCase())) {
                show = false;
            }

            // Type filter
            if (typeFilter && !type.toUpperCase().includes(typeFilter.toUpperCase())) {
                show = false;
            }

            // Outcome filter
            if (outcomeFilter) {
                const outcomeValue = outcome.replace(/[^A-Z]/g, ''); // Remove emojis
                if (!outcomeValue.includes(outcomeFilter.toUpperCase())) {
                    show = false;
                }
            }

            // Date filter
            if (dateFromFilter && dateCell) {
                const tradeDate = new Date(dateCell);
                const filterDate = new Date(dateFromFilter);
                if (tradeDate < filterDate) {
                    show = false;
                }
            }

            if (show) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        // Update pagination info
        const paginationInfo = document.querySelector('.pagination-info');
        if (paginationInfo) {
            paginationInfo.textContent = `Showing ${visibleCount} of ${rows.length} trades`;
        }

        showNotification(`Filtered to ${visibleCount} trades`, 'info');
    }

    function viewSignalDetails(signalId) {
        // Mock signal details - in real implementation, fetch from server
        const mockDetails = {
            symbol: 'NASDAQ',
            type: 'BUY',
            entryPrice: 23065.47,
            takeProfit: 23150.00,
            stopLoss: 23000.00,
            probability: 85.7,
            risk: 'MEDIUM',
            analysis: 'Strong bullish BOS detected with positive net change of +15.58. Market structure supports upward movement.',
            timestamp: new Date().toLocaleString()
        };

        // Create modal or navigate to details page
        showSignalModal(mockDetails);
    }

    function showSignalModal(details) {
        // Create modal overlay
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        `;

        modal.innerHTML = `
            <div style="
                background: var(--card-bg);
                border: 1px solid var(--golden-accent);
                border-radius: 12px;
                padding: 32px;
                max-width: 500px;
                width: 100%;
                backdrop-filter: blur(20px);
            ">
                <h3 style="color: var(--golden-primary); margin-bottom: 20px; font-size: 20px;">
                    📊 Signal Details
                </h3>
                <div style="display: grid; gap: 12px; margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Symbol:</span>
                        <span style="color: var(--text-primary); font-weight: 600;">${details.symbol}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Type:</span>
                        <span style="color: var(--text-primary); font-weight: 600;">${details.type}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Entry Price:</span>
                        <span style="color: var(--text-primary); font-weight: 600;">$${details.entryPrice.toLocaleString()}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Take Profit:</span>
                        <span style="color: var(--success-color); font-weight: 600;">$${details.takeProfit.toLocaleString()}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Stop Loss:</span>
                        <span style="color: var(--danger-color); font-weight: 600;">$${details.stopLoss.toLocaleString()}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Probability:</span>
                        <span style="color: var(--golden-primary); font-weight: 600;">${details.probability}%</span>
                    </div>
                </div>
                <div style="margin-bottom: 24px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 8px;">Analysis:</h4>
                    <p style="color: var(--text-secondary); line-height: 1.5; margin: 0;">${details.analysis}</p>
                </div>
                <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" 
                        style="
                            width: 100%;
                            padding: 12px 24px;
                            background: var(--golden-primary);
                            color: var(--primary-bg);
                            border: none;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                        ">
                    Close
                </button>
            </div>
        `;

        document.body.appendChild(modal);
    }

    function updateOutcome(signalId) {
        // Show outcome selection modal
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        `;

        modal.innerHTML = `
            <div style="
                background: var(--card-bg);
                border: 1px solid var(--golden-accent);
                border-radius: 12px;
                padding: 32px;
                max-width: 400px;
                width: 100%;
                backdrop-filter: blur(20px);
                text-align: center;
            ">
                <h3 style="color: var(--golden-primary); margin-bottom: 20px; font-size: 20px;">
                    📝 Update Signal Outcome
                </h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">
                    Select the outcome for this signal:
                </p>
                <div style="display: grid; gap: 12px; margin-bottom: 24px;">
                    <button onclick="submitOutcome('${signalId}', 'WIN')" 
                            style="
                                padding: 12px 24px;
                                background: rgba(0, 255, 136, 0.1);
                                color: var(--success-color);
                                border: 1px solid rgba(0, 255, 136, 0.2);
                                border-radius: 8px;
                                font-weight: 600;
                                cursor: pointer;
                            ">
                        ✅ WIN
                    </button>
                    <button onclick="submitOutcome('${signalId}', 'LOSS')" 
                            style="
                                padding: 12px 24px;
                                background: rgba(255, 71, 87, 0.1);
                                color: var(--danger-color);
                                border: 1px solid rgba(255, 71, 87, 0.2);
                                border-radius: 8px;
                                font-weight: 600;
                                cursor: pointer;
                            ">
                        ❌ LOSS
                    </button>
                    <button onclick="submitOutcome('${signalId}', 'BREAKEVEN')" 
                            style="
                                padding: 12px 24px;
                                background: rgba(255, 165, 2, 0.1);
                                color: var(--warning-color);
                                border: 1px solid rgba(255, 165, 2, 0.2);
                                border-radius: 8px;
                                font-weight: 600;
                                cursor: pointer;
                            ">
                        ⚖️ BREAKEVEN
                    </button>
                </div>
                <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" 
                        style="
                            padding: 8px 16px;
                            background: transparent;
                            color: var(--text-secondary);
                            border: 1px solid var(--golden-accent);
                            border-radius: 6px;
                            cursor: pointer;
                        ">
                    Cancel
                </button>
            </div>
        `;

        document.body.appendChild(modal);
    }

    function submitOutcome(signalId, outcome) {
        // In real implementation, send to server
        fetch('/update_signal_outcome', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                signal_id: signalId,
                outcome: outcome
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(`Signal outcome updated to ${outcome}`, 'success');
                // Refresh page or update row
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showNotification('Failed to update signal outcome', 'error');
            }
        })
        .catch(error => {
            showNotification('Error updating signal outcome', 'error');
        });

        // Close modal
        document.querySelector('[style*="position: fixed"]').remove();
    }

    function animateStatNumbers() {
        document.querySelectorAll('.big-number').forEach((element, index) => {
            const finalText = element.textContent;
            const finalValue = parseFloat(finalText.replace(/[^0-9.-]/g, ''));
            
            if (!isNaN(finalValue)) {
                element.textContent = '0';
                setTimeout(() => {
                    animateNumber(element, 0, finalValue, 1500, finalText);
                }, index * 200);
            }
        });
    }

    function animateNumber(element, start, end, duration, originalText) {
        const startTime = Date.now();
        const range = end - start;
        
        function update() {
            const now = Date.now();
            const elapsed = now - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            const current = start + (range * easeOutCubic(progress));
            
            if (originalText.includes('%')) {
                element.textContent = current.toFixed(1) + '%';
            } else if (originalText.includes('$')) {
                if (current >= 0) {
                    element.textContent = '+$' + current.toFixed(2);
                } else {
                    element.textContent = '$' + current.toFixed(2);
                }
            } else {
                element.textContent = Math.round(current);
            }
            
            if (progress < 1) {
                requestAnimationFrame(update);
            } else {
                element.textContent = originalText;
            }
        }
        
        update();
    }

    function easeOutCubic(t) {
        return 1 - Math.pow(1 - t, 3);
    }

    // Enhanced Modal Functions for Manual Trade Journal

    window.showTradeModalImpl = function(tradeData = null) {
        console.log('🔧 showTradeModal called with:', tradeData);
        const isEdit = tradeData !== null;
        const modalTitle = isEdit ? '✏️ Edit Trade' : '➕ Add New Trade';
        console.log('🔧 Modal title:', modalTitle);
        
        const modal = document.createElement('div');
        console.log('🔧 Modal element created');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        `;

        modal.innerHTML = `
            <div style="
                background: var(--card-bg);
                border: 1px solid var(--golden-accent);
                border-radius: 12px;
                padding: 0;
                max-width: 800px;
                width: 100%;
                max-height: 90vh;
                overflow-y: auto;
                backdrop-filter: blur(20px);
                animation: slideUp 0.3s ease;
            ">
                <!-- Modal Header -->
                <div style="
                    padding: 24px 32px;
                    border-bottom: 1px solid var(--golden-accent);
                    background: rgba(212, 175, 55, 0.05);
                ">
                    <h3 style="color: var(--golden-primary); margin: 0; font-size: 20px; font-weight: 600;">
                        ${modalTitle}
                    </h3>
                </div>
                
                <!-- Modal Body -->
                <div style="padding: 32px;">
                    <form id="tradeModalForm">
                        <!-- Trade Basic Info -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 16px; font-size: 16px;">
                                📊 Trade Information
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Symbol *</label>
                                    <select id="modal-symbol" name="symbol" required style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                        <option value="">Select Symbol</option>
                                        <option value="NASDAQ">NASDAQ</option>
                                        <option value="US30">US30</option>
                                        <option value="GOLD">GOLD</option>
                                        <option value="EUR/USD">EUR/USD</option>
                                        <option value="GBP/USD">GBP/USD</option>
                                        <option value="USD/JPY">USD/JPY</option>
                                        <option value="BTC/USD">BTC/USD</option>
                                        <option value="ETH/USD">ETH/USD</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Trade Type *</label>
                                    <select id="modal-trade-type" name="trade_type" required style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                        <option value="">Select Type</option>
                                        <option value="CALL">CALL (Bullish)</option>
                                        <option value="PUT">PUT (Bearish)</option>
                                        <option value="LONG">LONG (Buy)</option>
                                        <option value="SHORT">SHORT (Sell)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pricing -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 16px; font-size: 16px;">
                                💰 Pricing & Position
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Entry Price *</label>
                                    <input type="number" id="modal-entry-price" name="entry_price" step="0.01" required style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Exit Price</label>
                                    <input type="number" id="modal-exit-price" name="exit_price" step="0.01" style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Quantity</label>
                                    <input type="number" id="modal-quantity" name="quantity" min="1" value="1" style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Outcome -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 16px; font-size: 16px;">
                                📈 Trade Outcome
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Outcome</label>
                                    <select id="modal-outcome" name="outcome" style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                        <option value="PENDING">⏳ Pending</option>
                                        <option value="WIN">✅ Win</option>
                                        <option value="LOSS">❌ Loss</option>
                                        <option value="BREAKEVEN">⚖️ Breakeven</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Profit/Loss</label>
                                    <input type="number" id="modal-profit-loss" name="profit_loss" step="0.01" readonly style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.01);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Date/Time -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 16px; font-size: 16px;">
                                ⏰ Trade Timing
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Trade Date *</label>
                                    <input type="date" id="modal-trade-date" name="trade_date" required style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Entry Time</label>
                                    <input type="time" id="modal-entry-time" name="entry_time" style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Exit Time</label>
                                    <input type="time" id="modal-exit-time" name="exit_time" style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 16px; font-size: 16px;">
                                📝 Trade Notes
                            </h4>
                            <textarea id="modal-notes" name="notes" rows="3" placeholder="Trade analysis, lessons learned..." style="
                                width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.02);
                                border: 1px solid var(--golden-accent); border-radius: 6px;
                                color: var(--text-primary); font-size: 14px; resize: vertical;
                            "></textarea>
                        </div>
                        
                        <input type="hidden" id="modal-entry-id" name="entry_id" value="${isEdit ? tradeData.id : ''}">
                    </form>
                </div>
                
                <!-- Modal Footer -->
                <div style="
                    padding: 20px 32px;
                    border-top: 1px solid var(--golden-accent);
                    background: rgba(255, 255, 255, 0.01);
                    display: flex;
                    justify-content: flex-end;
                    gap: 12px;
                ">
                    <button onclick="closeModal()" style="
                        padding: 8px 16px;
                        background: transparent;
                        color: var(--text-secondary);
                        border: 1px solid var(--golden-accent);
                        border-radius: 6px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">
                        Cancel
                    </button>
                    <button onclick="submitTradeModal(${isEdit})" style="
                        padding: 8px 24px;
                        background: var(--golden-primary);
                        color: var(--primary-bg);
                        border: none;
                        border-radius: 6px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">
                        ${isEdit ? '💾 Update Trade' : '💾 Save Trade'}
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        
        // Populate form if editing
        if (isEdit && tradeData) {
            populateTradeModal(tradeData);
        } else {
            // Set defaults for new trade
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('modal-trade-date').value = today;
        }
        
        // Setup modal PnL calculator
        setupModalPnLCalculator();
    }

    function populateTradeModal(tradeData) {
        document.getElementById('modal-symbol').value = tradeData.symbol || '';
        document.getElementById('modal-trade-type').value = tradeData.trade_type || '';
        document.getElementById('modal-entry-price').value = tradeData.entry_price || '';
        document.getElementById('modal-exit-price').value = tradeData.exit_price || '';
        document.getElementById('modal-quantity').value = tradeData.quantity || 1;
        document.getElementById('modal-outcome').value = tradeData.outcome || 'PENDING';
        document.getElementById('modal-profit-loss').value = tradeData.profit_loss || '';
        document.getElementById('modal-trade-date').value = tradeData.trade_date || '';
        document.getElementById('modal-entry-time').value = tradeData.entry_time || '';
        document.getElementById('modal-exit-time').value = tradeData.exit_time || '';
        document.getElementById('modal-notes').value = tradeData.notes || '';
    }

    function setupModalPnLCalculator() {
        const elements = {
            entryPrice: document.getElementById('modal-entry-price'),
            exitPrice: document.getElementById('modal-exit-price'),
            tradeType: document.getElementById('modal-trade-type'),
            quantity: document.getElementById('modal-quantity'),
            outcome: document.getElementById('modal-outcome'),
            profitLoss: document.getElementById('modal-profit-loss')
        };
        
        function calculateModalPnL() {
            const entry = parseFloat(elements.entryPrice.value) || 0;
            const exit = parseFloat(elements.exitPrice.value) || 0;
            const type = elements.tradeType.value;
            const qty = parseInt(elements.quantity.value) || 1;
            const result = elements.outcome.value;
            
            if (entry > 0 && exit > 0 && type) {
                let pnl = 0;
                
                if (type === 'LONG' || type === 'CALL') {
                    pnl = (exit - entry) * qty;
                } else if (type === 'SHORT' || type === 'PUT') {
                    pnl = (entry - exit) * qty;
                }
                
                if (result === 'LOSS') {
                    pnl = Math.abs(pnl) * -1;
                } else if (result === 'BREAKEVEN') {
                    pnl = 0;
                }
                
                elements.profitLoss.value = pnl.toFixed(2);
            } else {
                elements.profitLoss.value = '';
            }
        }
        
        Object.values(elements).forEach(element => {
            if (element) {
                element.addEventListener('input', calculateModalPnL);
                element.addEventListener('change', calculateModalPnL);
            }
        });
    }

    window.submitTradeModalImpl = function(isEdit = false) {
        console.log('🔧 Submit trade modal called, isEdit:', isEdit);
        const form = document.getElementById('tradeModalForm');
        const formData = new FormData(form);
        
        const url = isEdit ? 
            `/api/update_journal_entry/${formData.get('entry_id')}` : 
            '/api/create_journal_entry';
        const method = 'POST';
        
        fetch(url, {
            method: method,
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(
                    isEdit ? 'Trade updated successfully!' : 'Trade saved successfully!', 
                    'success'
                );
                closeModal();
                // Refresh the page to show updated data
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showNotification(`Error: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Network error. Please try again.', 'error');
        });
    }

    window.closeModalImpl = function() {
        console.log('🔧 Close modal called');
        const modal = document.querySelector('[style*="position: fixed"]');
        if (modal) {
            modal.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            }, 300);
        }
    }

    window.viewTradeDetailsImpl = function(entryId) {
        console.log('🔧 View trade details called for ID:', entryId);
        fetch(`/api/get_journal_entry/${entryId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showTradeDetailsModal(data.entry);
            } else {
                showNotification('Error loading trade details', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error loading trade details', 'error');
        });
    }

    // Main modal implementation function
    window.openTradeModalImpl = function(tradeData = null) {
        console.log('🔧 openTradeModalImpl called with data:', tradeData);
        const isEdit = tradeData !== null;
        
        // Remove existing modal if any
        const existingModal = document.querySelector('[data-modal="trade-modal"]');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Create modal HTML
        const modal = document.createElement('div');
        modal.setAttribute('data-modal', 'trade-modal');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        `;
        
        modal.innerHTML = `
            <div style="
                background: var(--card-bg);
                border: 1px solid var(--golden-accent);
                border-radius: 12px;
                max-width: 600px;
                width: 100%;
                max-height: 90vh;
                overflow-y: auto;
                backdrop-filter: blur(20px);
                animation: slideIn 0.3s ease;
            ">
                <!-- Modal Header -->
                <div style="
                    padding: 24px 32px;
                    border-bottom: 1px solid var(--golden-accent);
                    background: rgba(212, 175, 55, 0.05);
                ">
                    <h3 style="
                        color: var(--golden-primary);
                        margin: 0;
                        font-size: 24px;
                        font-weight: 700;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    ">
                        ${isEdit ? '✏️ Edit Trade' : '➕ Add New Trade'}
                    </h3>
                </div>
                
                <!-- Modal Body -->
                <div style="padding: 32px;">
                    <form id="tradeModalForm">
                        <!-- Symbol & Type -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 16px; font-size: 16px;">
                                📊 Trade Details
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Symbol *</label>
                                    <input type="text" id="modal-symbol" name="symbol" required placeholder="e.g., AAPL, EURUSD" style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Trade Type *</label>
                                    <select id="modal-trade-type" name="trade_type" required style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                        <option value="">Select Type</option>
                                        <option value="LONG">📈 Long</option>
                                        <option value="SHORT">📉 Short</option>
                                        <option value="CALL">📞 Call Option</option>
                                        <option value="PUT">📱 Put Option</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Prices -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 16px; font-size: 16px;">
                                💰 Price Information
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Entry Price *</label>
                                    <input type="number" id="modal-entry-price" name="entry_price" step="0.01" required style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Exit Price</label>
                                    <input type="number" id="modal-exit-price" name="exit_price" step="0.01" style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Quantity</label>
                                    <input type="number" id="modal-quantity" name="quantity" min="1" value="1" style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Outcome -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 16px; font-size: 16px;">
                                📈 Trade Outcome
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Outcome</label>
                                    <select id="modal-outcome" name="outcome" style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                        <option value="PENDING">⏳ Pending</option>
                                        <option value="WIN">✅ Win</option>
                                        <option value="LOSS">❌ Loss</option>
                                        <option value="BREAKEVEN">⚖️ Breakeven</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Profit/Loss</label>
                                    <input type="number" id="modal-profit-loss" name="profit_loss" step="0.01" style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Date/Time -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 16px; font-size: 16px;">
                                ⏰ Trade Timing
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Trade Date *</label>
                                    <input type="date" id="modal-trade-date" name="trade_date" required style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Entry Time</label>
                                    <input type="time" id="modal-entry-time" name="entry_time" style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Exit Time</label>
                                    <input type="time" id="modal-exit-time" name="exit_time" style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 16px; font-size: 16px;">
                                📝 Trade Notes
                            </h4>
                            <textarea id="modal-notes" name="notes" rows="3" placeholder="Trade analysis, lessons learned, strategy notes..." style="
                                width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.02);
                                border: 1px solid var(--golden-accent); border-radius: 6px;
                                color: var(--text-primary); font-size: 14px; resize: vertical;
                            "></textarea>
                        </div>
                        
                        <input type="hidden" id="modal-entry-id" name="entry_id" value="${isEdit && tradeData ? tradeData.id : ''}">
                    </form>
                </div>
                
                <!-- Modal Footer -->
                <div style="
                    padding: 20px 32px;
                    border-top: 1px solid var(--golden-accent);
                    background: rgba(255, 255, 255, 0.01);
                    display: flex;
                    justify-content: flex-end;
                    gap: 12px;
                ">
                    <button onclick="closeModal()" style="
                        padding: 8px 16px;
                        background: transparent;
                        color: var(--text-secondary);
                        border: 1px solid var(--golden-accent);
                        border-radius: 6px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">
                        Cancel
                    </button>
                    <button onclick="submitTradeModal(${isEdit})" style="
                        padding: 8px 24px;
                        background: var(--golden-primary);
                        color: var(--primary-bg);
                        border: none;
                        border-radius: 6px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">
                        ${isEdit ? '💾 Update Trade' : '💾 Save Trade'}
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Populate form if editing
        if (isEdit && tradeData) {
            populateTradeModal(tradeData);
        } else {
            // Set defaults for new trade
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('modal-trade-date').value = today;
        }
        
        // Setup modal PnL calculator
        setupModalPnLCalculator();
        
        // Focus on symbol input
        setTimeout(() => {
            const symbolInput = document.getElementById('modal-symbol');
            if (symbolInput) symbolInput.focus();
        }, 100);
    };
    
    // Ensure function is globally accessible immediately
    console.log('🚀 Defining openTradeModal function...');
    
    // Main modal functions for trading journal - define openTradeModal directly
    window.openTradeModal = function(tradeData = null) {
        console.log('🔧 openTradeModal called with data:', tradeData);
        const isEdit = tradeData !== null;
        
        // Remove existing modal if any
        const existingModal = document.querySelector('[data-modal="trade-modal"]');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Create modal HTML
        const modal = document.createElement('div');
        modal.setAttribute('data-modal', 'trade-modal');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        `;
        
        modal.innerHTML = `
            <div style="
                background: var(--card-bg);
                border: 1px solid var(--golden-accent);
                border-radius: 12px;
                max-width: 600px;
                width: 100%;
                max-height: 90vh;
                overflow-y: auto;
                backdrop-filter: blur(20px);
                animation: slideIn 0.3s ease;
            ">
                <!-- Modal Header -->
                <div style="
                    padding: 24px 32px;
                    border-bottom: 1px solid var(--golden-accent);
                    background: rgba(212, 175, 55, 0.05);
                ">
                    <h3 style="
                        color: var(--golden-primary);
                        margin: 0;
                        font-size: 24px;
                        font-weight: 700;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    ">
                        ${isEdit ? '✏️ Edit Trade' : '➕ Add New Trade'}
                    </h3>
                </div>
                
                <!-- Modal Body -->
                <div style="padding: 32px;">
                    <form id="tradeModalForm">
                        <!-- Symbol & Type -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 16px; font-size: 16px;">
                                📊 Trade Details
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Symbol *</label>
                                    <input type="text" id="modal-symbol" name="symbol" required placeholder="e.g., AAPL, EURUSD" style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Trade Type *</label>
                                    <select id="modal-trade-type" name="trade_type" required style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                        <option value="">Select Type</option>
                                        <option value="LONG">📈 Long</option>
                                        <option value="SHORT">📉 Short</option>
                                        <option value="CALL">📞 Call Option</option>
                                        <option value="PUT">📱 Put Option</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Prices -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 16px; font-size: 16px;">
                                💰 Price Information
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Entry Price *</label>
                                    <input type="number" id="modal-entry-price" name="entry_price" step="0.01" required style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Exit Price</label>
                                    <input type="number" id="modal-exit-price" name="exit_price" step="0.01" style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Quantity</label>
                                    <input type="number" id="modal-quantity" name="quantity" min="1" value="1" style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Outcome -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 16px; font-size: 16px;">
                                📈 Trade Outcome
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Outcome</label>
                                    <select id="modal-outcome" name="outcome" style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                        <option value="PENDING">⏳ Pending</option>
                                        <option value="WIN">✅ Win</option>
                                        <option value="LOSS">❌ Loss</option>
                                        <option value="BREAKEVEN">⚖️ Breakeven</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Profit/Loss</label>
                                    <input type="number" id="modal-profit-loss" name="profit_loss" step="0.01" style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Date/Time -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 16px; font-size: 16px;">
                                ⏰ Trade Timing
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Trade Date *</label>
                                    <input type="date" id="modal-trade-date" name="trade_date" required style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Entry Time</label>
                                    <input type="time" id="modal-entry-time" name="entry_time" style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                                <div>
                                    <label style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block;">Exit Time</label>
                                    <input type="time" id="modal-exit-time" name="exit_time" style="
                                        width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.02);
                                        border: 1px solid var(--golden-accent); border-radius: 6px;
                                        color: var(--text-primary); font-size: 14px;
                                    ">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 16px; font-size: 16px;">
                                📝 Trade Notes
                            </h4>
                            <textarea id="modal-notes" name="notes" rows="3" placeholder="Trade analysis, lessons learned, strategy notes..." style="
                                width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.02);
                                border: 1px solid var(--golden-accent); border-radius: 6px;
                                color: var(--text-primary); font-size: 14px; resize: vertical;
                            "></textarea>
                        </div>
                        
                        <input type="hidden" id="modal-entry-id" name="entry_id" value="${isEdit && tradeData ? tradeData.id : ''}">
                    </form>
                </div>
                
                <!-- Modal Footer -->
                <div style="
                    padding: 20px 32px;
                    border-top: 1px solid var(--golden-accent);
                    background: rgba(255, 255, 255, 0.01);
                    display: flex;
                    justify-content: flex-end;
                    gap: 12px;
                ">
                    <button onclick="closeModal()" style="
                        padding: 8px 16px;
                        background: transparent;
                        color: var(--text-secondary);
                        border: 1px solid var(--golden-accent);
                        border-radius: 6px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">
                        Cancel
                    </button>
                    <button onclick="submitTradeModal(${isEdit})" style="
                        padding: 8px 24px;
                        background: var(--golden-primary);
                        color: var(--primary-bg);
                        border: none;
                        border-radius: 6px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">
                        ${isEdit ? '💾 Update Trade' : '💾 Save Trade'}
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Populate form if editing
        if (isEdit && tradeData) {
            populateTradeModal(tradeData);
        } else {
            // Set defaults for new trade
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('modal-trade-date').value = today;
        }
        
        // Setup modal PnL calculator
        setupModalPnLCalculator();
        
        // Focus on symbol input
        setTimeout(() => {
            const symbolInput = document.getElementById('modal-symbol');
            if (symbolInput) symbolInput.focus();
        }, 100);
    };
    
    console.log('🚀 openTradeModal function defined:', typeof window.openTradeModal);
    
    // Define closeModal function
    window.closeModal = function() {
        const modal = document.querySelector('[data-modal="trade-modal"]');
        if (modal) {
            modal.remove();
        }
    };
    
    window.submitTradeModal = function(isEdit = false) {
        console.log('🔧 submitTradeModal called, isEdit:', isEdit);
        return window.submitTradeModalImpl(isEdit);
    };
    
    window.closeModal = function() {
        console.log('🔧 closeModal called');
        return window.closeModalImpl();
    };
    
    window.viewTradeDetails = function(entryId) {
        console.log('🔧 viewTradeDetails called for ID:', entryId);
        return window.viewTradeDetailsImpl(entryId);
    };
    
    window.editTrade = function(entryId) {
        console.log('🔧 editTrade called for ID:', entryId);
        fetch(`/api/get_journal_entry/${entryId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.openTradeModal(data.entry);
            } else {
                showNotification('Error loading trade for editing', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error loading trade for editing', 'error');
        });
    };
    
    window.deleteTrade = function(entryId) {
        console.log('🔧 deleteTrade called for ID:', entryId);
        if (confirm('Are you sure you want to delete this trade? This action cannot be undone.')) {
            fetch(`/api/delete_journal_entry/${entryId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Trade deleted successfully!', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(`Error: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error deleting trade', 'error');
            });
        }
    };
    
    window.toggleFilters = function() {
        console.log('🔧 toggleFilters called');
        const filtersContainer = document.getElementById('filtersContainer');
        if (filtersContainer) {
            const isHidden = filtersContainer.style.display === 'none';
            filtersContainer.style.display = isHidden ? 'block' : 'none';
        }
    };
    console.log('✅ Trading Journal page loaded successfully');
    
    // The new modal system is loaded via external JS file
    // All modal functionality is handled by trading-journal-modal.js

    function showTradeDetailsModal(trade) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        `;

        modal.innerHTML = `
            <div style="
                background: var(--card-bg);
                border: 1px solid var(--golden-accent);
                border-radius: 12px;
                padding: 32px;
                max-width: 600px;
                width: 100%;
                backdrop-filter: blur(20px);
            ">
                <h3 style="color: var(--golden-primary); margin-bottom: 24px; font-size: 24px;">
                    👁️ Trade Details
                </h3>
                
                <div style="display: grid; gap: 16px; margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Symbol</div>
                            <div style="color: var(--golden-primary); font-size: 18px; font-weight: 600;">${trade.symbol}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Type</div>
                            <div style="color: var(--text-primary); font-size: 16px; font-weight: 600;">${trade.trade_type}</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        <div>
                            <div style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Entry Price</div>
                            <div style="color: var(--text-primary); font-size: 16px; font-weight: 600;">$${trade.entry_price?.toFixed(2) || 'N/A'}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Exit Price</div>
                            <div style="color: var(--text-primary); font-size: 16px; font-weight: 600;">$${trade.exit_price?.toFixed(2) || 'N/A'}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Quantity</div>
                            <div style="color: var(--text-primary); font-size: 16px; font-weight: 600;">${trade.quantity}</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Outcome</div>
                            <div style="font-size: 16px; font-weight: 600;">
                                ${trade.outcome === 'WIN' ? '<span style="color: var(--success-color);">✅ WIN</span>' :
                                  trade.outcome === 'LOSS' ? '<span style="color: var(--danger-color);">❌ LOSS</span>' :
                                  trade.outcome === 'BREAKEVEN' ? '<span style="color: var(--warning-color);">⚖️ BREAKEVEN</span>' :
                                  '<span style="color: var(--text-muted);">⏳ PENDING</span>'}
                            </div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">P&L</div>
                            <div style="font-size: 18px; font-weight: 700; color: ${
                                trade.profit_loss > 0 ? 'var(--success-color)' :
                                trade.profit_loss < 0 ? 'var(--danger-color)' : 'var(--text-muted)'
                            };">
                                ${trade.profit_loss !== null ? 
                                  (trade.profit_loss >= 0 ? '+' : '') + '$' + trade.profit_loss.toFixed(2) : 
                                  'N/A'}
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Date & Time</div>
                        <div style="color: var(--text-primary); font-size: 14px;">
                            ${trade.trade_date}${trade.entry_time ? ` at ${trade.entry_time}` : ''}
                            ${trade.exit_time ? ` → ${trade.exit_time}` : ''}
                        </div>
                    </div>
                    
                    ${trade.notes ? `
                    <div>
                        <div style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 8px;">Notes</div>
                        <div style="color: var(--text-primary); line-height: 1.5; background: rgba(255, 255, 255, 0.02); padding: 12px; border-radius: 6px; border: 1px solid var(--golden-accent);">
                            ${trade.notes}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${trade.chart_image_path ? `
                    <div>
                        <div style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 8px;">Chart</div>
                        <button onclick="viewChart('${trade.chart_image_path}')" style="
                            padding: 8px 16px;
                            background: var(--golden-primary);
                            color: var(--primary-bg);
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-weight: 600;
                        ">
                            🖼️ View Chart
                        </button>
                    </div>
                    ` : ''}
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="closeModal()" style="
                        padding: 8px 16px;
                        background: transparent;
                        color: var(--text-secondary);
                        border: 1px solid var(--golden-accent);
                        border-radius: 6px;
                        cursor: pointer;
                    ">
                        Close
                    </button>
                    <button onclick="editTrade(${trade.id}); closeModal();" style="
                        padding: 8px 16px;
                        background: var(--golden-primary);
                        color: var(--primary-bg);
                        border: none;
                        border-radius: 6px;
                        font-weight: 600;
                        cursor: pointer;
                    ">
                        ✏️ Edit Trade
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
    }

    window.editTradeImpl = function(entryId) {
        console.log('🔧 Edit trade called for ID:', entryId);
        fetch(`/journal/api/entry/${entryId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.showTradeModalImpl(data.entry);
            } else {
                showNotification('Error loading trade for editing', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error loading trade for editing', 'error');
        });
    }

    window.deleteTradeImpl = function(entryId) {
        console.log('🔧 Delete trade called for ID:', entryId);
        if (confirm('Are you sure you want to delete this trade? This action cannot be undone.')) {
            fetch(`/journal/api/entry/${entryId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Trade deleted successfully', 'success');
                    // Remove the row from the table
                    const row = document.querySelector(`[data-entry-id="${entryId}"]`);
                    if (row) {
                        row.style.animation = 'fadeOut 0.3s ease';
                        setTimeout(() => {
                            row.remove();
                            updatePaginationInfo();
                        }, 300);
                    }
                } else {
                    showNotification(`Error: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error deleting trade', 'error');
            });
        }
    }

    window.viewChartImpl = function(imagePath) {
        console.log('🔧 View chart called for:', imagePath);
        if (!imagePath) return;
        
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            cursor: pointer;
        `;

        modal.innerHTML = `
            <div style="
                max-width: 95vw;
                max-height: 95vh;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
            ">
                <img src="${imagePath}" alt="Trading Chart" style="
                    max-width: 100%;
                    max-height: 100%;
                    border-radius: 8px;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                ">
                <button onclick="closeModal()" style="
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: rgba(255, 71, 87, 0.9);
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 32px;
                    height: 32px;
                    font-size: 16px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">
                    ✕
                </button>
            </div>
        `;

        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });

        document.body.appendChild(modal);
    }

    function updatePaginationInfo() {
        const visibleRows = document.querySelectorAll('#tradesTableBody tr:not([style*="display: none"])');
        const totalRows = document.querySelectorAll('#tradesTableBody tr');
        const paginationInfo = document.getElementById('paginationInfo');
        
        if (paginationInfo) {
            paginationInfo.textContent = `Showing ${visibleRows.length} of ${totalRows.length} trades`;
        }
    }

    window.loadPageImpl = function(page) {
        console.log('🔧 Load page called for page:', page);
        // Placeholder for pagination functionality
        showNotification('Pagination coming soon!', 'info');
    }

    window.exportTradesImpl = function() {
        console.log('🔧 Export trades called');
        // Get all visible trades (considering filters)
        const visibleRows = document.querySelectorAll('#tradesTableBody tr:not([style*="display: none"])');
        
        if (visibleRows.length === 0) {
            showNotification('No trades to export', 'warning');
            return;
        }
        
        // Create CSV content
        const csvHeaders = [
            'Symbol', 'Trade Type', 'Entry Price', 'Exit Price', 'Quantity', 
            'Outcome', 'Profit/Loss', 'Trade Date', 'Entry Time', 'Exit Time', 'Notes'
        ];
        
        let csvContent = csvHeaders.join(',') + '\n';
        
        visibleRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const csvRow = [
                cleanCellText(cells[0]), // Symbol
                cleanCellText(cells[1]), // Type
                cleanCellText(cells[2]), // Entry Price
                cleanCellText(cells[3]), // Exit Price
                cleanCellText(cells[4]), // Quantity
                cleanCellText(cells[5]), // Outcome
                cleanCellText(cells[6]), // P&L
                cleanCellText(cells[7]), // Date
                '', // Entry Time (would need to be extracted from backend)
                '', // Exit Time (would need to be extracted from backend)
                '' // Notes (would need to be extracted from backend)
            ];
            
            csvContent += csvRow.map(field => `"${field}"`).join(',') + '\n';
        });
        
        // Download CSV
        downloadCSV(csvContent, `manual_trades_${new Date().toISOString().split('T')[0]}.csv`);
        
        showNotification(`Exported ${visibleRows.length} trades to CSV`, 'success');
    }
    
    function cleanCellText(cell) {
        if (!cell) return '';
        
        // Remove emojis and extra whitespace
        let text = cell.textContent.trim();
        text = text.replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '');
        text = text.replace(/\s+/g, ' ').trim();
        
        // Clean currency symbols and special characters
        if (text.includes('$')) {
            text = text.replace(/[$,]/g, '');
        }
        
        return text;
    }
    
    function downloadCSV(csvContent, filename) {
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }
    
    // Enhanced search functionality
    function initializeSearch() {
        // Add search input to filter panel
        const filtersGrid = document.querySelector('.filters-grid');
        if (filtersGrid) {
            const searchHTML = `
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" class="filter-input" id="searchFilter" 
                           placeholder="Search trades..." onkeyup="performSearch()">
                </div>
            `;
            filtersGrid.insertAdjacentHTML('beforeend', searchHTML);
        }
    }
    
    window.performSearchImpl = function() {
        console.log('🔧 Perform search called');
        const searchTerm = document.getElementById('searchFilter')?.value.toLowerCase() || '';
        
        if (searchTerm === '') {
            window.applyFiltersImpl(); // Reset to current filters
            return;
        }
        
        const rows = document.querySelectorAll('.journal-table tbody tr');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const rowText = row.textContent.toLowerCase();
            const isVisible = rowText.includes(searchTerm);
            
            if (isVisible) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update pagination info
        const paginationInfo = document.querySelector('.pagination-info');
        if (paginationInfo) {
            paginationInfo.textContent = `Showing ${visibleCount} of ${rows.length} trades`;
        }
    }
    
    // Keyboard shortcuts
    function initializeKeyboardShortcuts() {
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + N = New Trade
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                openTradeModal();
            }
            
            // Ctrl/Cmd + F = Focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                const searchInput = document.getElementById('searchFilter');
                if (searchInput) {
                    if (!document.getElementById('filtersPanel').classList.contains('active')) {
                        toggleFilters();
                    }
                    setTimeout(() => searchInput.focus(), 100);
                }
            }
            
            // Escape = Close modals
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    }

    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(300px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(300px); opacity: 0; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
    `;
    document.head.appendChild(style);

// =======================================================
// DOM CONTENT LOADED EVENT HANDLER - ATTACH EVENTS
// =======================================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 DOM Content Loaded - Initializing Trading Journal');
    
    // Debug function availability
    window.debugFunctions();
    
    // Add event listeners for main buttons
    const addTradeBtn = document.getElementById('addTradeBtn');
    const addFirstTradeBtn = document.getElementById('addFirstTradeBtn');
    const filterBtn = document.getElementById('filterBtn');
    const exportBtn = document.getElementById('exportBtn');
    
    // Add New Trade button
    if (addTradeBtn) {
        console.log('✅ Found Add Trade button, attaching event listener');
        addTradeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('🔧 Add Trade button clicked via event listener');
            
            if (typeof window.openTradeModal === 'function') {
                window.openTradeModal();
            } else {
                console.error('❌ openTradeModal not available');
                alert('Modal functionality not ready. Please refresh the page.');
            }
        });
    } else {
        console.log('ℹ️ Add Trade button not found (normal if there are existing trades)');
    }
    
    // Add First Trade button (for empty state)
    if (addFirstTradeBtn) {
        console.log('✅ Found Add First Trade button, attaching event listener');
        addFirstTradeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('🔧 Add First Trade button clicked via event listener');
            
            if (typeof window.openTradeModal === 'function') {
                window.openTradeModal();
            } else {
                console.error('❌ openTradeModal not available');
                alert('Modal functionality not ready. Please refresh the page.');
            }
        });
    } else {
        console.log('ℹ️ Add First Trade button not found (normal if there are existing trades)');
    }
    
    // Filter button
    if (filterBtn) {
        console.log('✅ Found Filter button, attaching event listener');
        filterBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (typeof window.toggleFilters === 'function') {
                window.toggleFilters();
            } else {
                console.error('❌ toggleFilters not available');
            }
        });
    }
    
    // Export button
    if (exportBtn) {
        console.log('✅ Found Export button, attaching event listener');
        exportBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (typeof window.exportTrades === 'function') {
                window.exportTrades();
            } else {
                console.error('❌ exportTrades not available');
            }
        });
    }
    
    // Add event listeners for dynamic trade row buttons (View, Edit, Delete)
    // These are generated dynamically, so we'll use event delegation
    document.body.addEventListener('click', function(e) {
        const target = e.target;
        
        // Check if it's a trade action button
        if (target.matches('[data-action="view-trade"]')) {
            e.preventDefault();
            const entryId = target.getAttribute('data-entry-id');
            console.log('🔧 View trade button clicked for ID:', entryId);
            
            if (typeof window.viewTradeDetails === 'function') {
                window.viewTradeDetails(entryId);
            } else {
                console.error('❌ viewTradeDetails not available');
            }
        }
        
        if (target.matches('[data-action="edit-trade"]')) {
            e.preventDefault();
            const entryId = target.getAttribute('data-entry-id');
            console.log('🔧 Edit trade button clicked for ID:', entryId);
            
            if (typeof window.editTrade === 'function') {
                window.editTrade(entryId);
            } else {
                console.error('❌ editTrade not available');
            }
        }
        
        if (target.matches('[data-action="delete-trade"]')) {
            e.preventDefault();
            const entryId = target.getAttribute('data-entry-id');
            console.log('🔧 Delete trade button clicked for ID:', entryId);
            
            if (typeof window.deleteTrade === 'function') {
                window.deleteTrade(entryId);
            } else {
                console.error('❌ deleteTrade not available');
            }
        }
    });
    
    console.log('✅ Trading Journal initialization complete');
    
    // Global availability check (for debugging)
    setTimeout(() => {
        console.log('🔍 Final function availability check:');
        window.debugFunctions();
    }, 1000);
});
</script>
{% endblock %}