name: Deploy BFI Signals to VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual deployment

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          echo "ğŸš€ Starting deployment..."
          
          # Show current user and environment
          echo "ğŸ‘¤ Current user: $(whoami)"
          echo "ğŸ“‚ Home directory: $HOME"
          echo "ğŸ“ Current directory: $(pwd)"
          
          # List available directories to debug
          echo "ğŸ“‚ Available directories in /home:"
          ls -la /home/ || echo "Cannot access /home"
          
          # Try different possible paths
          if [ -d "/home/bfi-signals/app" ]; then
              APP_DIR="/home/bfi-signals/app"
          elif [ -d "$HOME/bfi-signals" ]; then
              APP_DIR="$HOME/bfi-signals"
          elif [ -d "$HOME/app" ]; then
              APP_DIR="$HOME/app"
          elif [ -d "/var/www/bfi-signals" ]; then
              APP_DIR="/var/www/bfi-signals"
          else
              echo "âŒ Could not find application directory"
              echo "ğŸ“‚ Checking common locations:"
              ls -la /home/ 2>/dev/null || echo "No access to /home"
              ls -la $HOME/ 2>/dev/null || echo "No access to HOME"
              ls -la /var/www/ 2>/dev/null || echo "No access to /var/www"
              exit 1
          fi
          
          echo "ğŸ“ Found application directory: $APP_DIR"
          cd "$APP_DIR" || {
              echo "âŒ Failed to navigate to $APP_DIR"
              exit 1
          }
          
          # Show current status
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸŒŸ Current commit: $(git rev-parse --short HEAD)"
          
          # Backup current state
          echo "ğŸ’¾ Creating backup..."
          # Stop service if it exists
          if systemctl is-active --quiet bfi-signals.service 2>/dev/null; then
              echo "ğŸ›‘ Stopping BFI service..."
              sudo systemctl stop bfi-signals.service || echo "âš ï¸ Could not stop service"
          else
              echo "â„¹ï¸ BFI service not running or doesn't exist"
          fi
          
          # Backup database if it exists
          if [ -f "core/ai_learning.db" ]; then
              cp core/ai_learning.db core/ai_learning.db.backup.$(date +%Y%m%d_%H%M%S) || echo "âš ï¸ Could not backup database"
              echo "âœ… Database backed up"
          else
              echo "â„¹ï¸ No database to backup"
          fi
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest changes..."
          git stash --include-untracked || true
          git pull origin master
          
          # Activate virtual environment and update dependencies
          echo "ğŸ“¦ Updating dependencies..."
          if [ ! -d "venv" ]; then
              echo "ğŸ”§ Creating virtual environment..."
              python3 -m venv venv
          fi
          
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # Ensure all required packages are installed
          pip install flask requests beautifulsoup4 pandas python-dotenv pytz lxml schedule bcrypt
          
          # Run any database migrations if needed
          echo "ğŸ—„ï¸ Checking database..."
          python3 -c "
          import sqlite3
          import os
          if os.path.exists('core/ai_learning.db'):
              conn = sqlite3.connect('core/ai_learning.db')
              cursor = conn.cursor()
              # Add any migration code here if needed
              conn.close()
              print('âœ… Database check complete')
          else:
              print('â„¹ï¸ Database will be created on first run')
          " || true
          
          # Test application
          echo "ğŸ§ª Testing application..."
          cd core && timeout 10s python3 -c "
          import sys, os
          sys.path.insert(0, os.getcwd())
          try:
              # Test basic imports first
              import flask
              print('âœ… Flask import successful')
              
              # Test application import
              from dashboard import app
              print('âœ… Application imports successfully')
          except ImportError as e:
              print(f'âŒ Import failed: {e}')
              print('ğŸ“‹ Installing missing dependencies...')
              exit(0)  # Continue deployment even if test fails
          except Exception as e:
              print(f'âš ï¸ Application test warning: {e}')
              exit(0)  # Continue deployment
          " && cd .. || (echo "âš ï¸ Application test completed with warnings, continuing deployment..." && cd ..)
          
          # Restart services
          echo "ğŸ”„ Restarting services..."
          
          # Start BFI service
          if sudo systemctl start bfi-signals.service 2>/dev/null; then
              echo "âœ… BFI service started successfully"
          else
              echo "âš ï¸ Could not start BFI service (might not be configured yet)"
              echo "ğŸ“‹ Checking if service file exists..."
              if [ -f "/etc/systemd/system/bfi-signals.service" ]; then
                  echo "Service file exists, checking logs..."
                  sudo journalctl -u bfi-signals.service --no-pager -n 10 || true
              else
                  echo "Service file does not exist - manual setup required"
              fi
          fi
          
          # Reload nginx if available
          if sudo systemctl reload nginx 2>/dev/null; then
              echo "âœ… Nginx reloaded successfully"
          else
              echo "âš ï¸ Could not reload nginx (might not be configured)"
          fi
          
          # Wait for services to start
          sleep 3
          
          # Test HTTP endpoint
          echo "ğŸŒ Testing HTTP endpoint..."
          if curl -s -o /dev/null -w "%{http_code}" http://localhost:5000 | grep -q "200\|302\|401"; then
              echo "âœ… Application is responding"
          else
              echo "âŒ Application is not responding"
              sudo journalctl -u bfi-signals.service --no-pager -n 10
              exit 1
          fi
          
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“Š New commit: $(git rev-parse --short HEAD)"
          echo "ğŸŒ Site available at: https://bonangfinance.co.za"
    
    - name: Notify on success
      if: success()
      run: |
        echo "âœ… Deployment successful!"
        
    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Deployment failed! Check the logs above."